#!/usr/bin/env bash
set -euo pipefail

ROOT="/var/www/augur"
VAULT_DEFAULT="$ROOT/vault/sample_vault"
VAULT_PATH="${AUGUR_VAULT_PATH:-${DL_VAULT_PATH:-$VAULT_DEFAULT}}"
API_BASE="http://127.0.0.1:8787"
LOG_FILE="/tmp/augur_api.log"

run_root() { (cd "$ROOT" && pnpm "$@"); }

need_api() {
  curl -fsS "$API_BASE/health" >/dev/null 2>&1 || {
    echo "[augur] api not reachable on :8787"
    echo "[augur] run: augur api or augur api:bg"
    exit 1
  }
}

usage() {
  cat <<'TXT'
AUGUR CLI

Core
  augur status
  augur api            foreground api
  augur api:bg         background api
  augur api:stop       stop port 8787 listener
  augur api:logs       tail api log
  augur snapshot
  augur monthly YYYY-MM
  augur publish

Accounts
  augur accounts        active only
  augur accounts:all    all statuses
  augur add CHAIN ADDRESS LABEL [NETWORK]
  augur pause ACCOUNT_ID
  augur resume ACCOUNT_ID
  augur delete ACCOUNT_ID
  augur purge:deleted   purge deleted accounts via API
TXT
}

cmd="${1:-}"
case "$cmd" in
  ""|"-h"|"--help"|"help")
    usage
    exit 0
    ;;

  status)
    echo "{\"root\":\"$ROOT\",\"vault\":\"$VAULT_PATH\",\"api\":\"$API_BASE\",\"log\":\"$LOG_FILE\"}"
    ;;

  api)
    (cd "$ROOT/apps/api" && VAULT_PATH="$VAULT_PATH" pnpm start)
    ;;

  api:bg)
    port=8787
    if ss -ltnp 2>/dev/null | grep -q ":$port"; then
      echo "[augur] already listening on :$port"
      exit 0
    fi
    : >"$LOG_FILE" || true
    nohup bash -lc "cd '$ROOT/apps/api' && VAULT_PATH='$VAULT_PATH' pnpm start" >>"$LOG_FILE" 2>&1 &
    sleep 1
    if curl -fsS "$API_BASE/health" >/dev/null 2>&1; then
      echo "[augur] api up (bg) log=$LOG_FILE"
    else
      echo "[augur] api not healthy yet, see log=$LOG_FILE"
      exit 1
    fi
    ;;

  api:stop)
    port=8787
    pid="$(ss -ltnp 2>/dev/null | awk -v p=":$port" '$0 ~ p {print $0}' | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' | head -n 1 || true)"
    if [ -n "${pid:-}" ]; then
      kill "$pid" || true
      echo "[augur] killed :$port"
    else
      echo "[augur] nothing on :$port"
    fi
    ;;

  api:logs)
    if [ -f "$LOG_FILE" ]; then
      tail -n 200 -f "$LOG_FILE"
    else
      echo "[augur] no log yet at $LOG_FILE"
      echo "[augur] run: augur api:bg"
      exit 1
    fi
    ;;

  accounts)
    need_api
    curl -fsS "$API_BASE/api/accounts?active=1"
    ;;

  accounts:all)
    need_api
    curl -fsS "$API_BASE/api/accounts"
    ;;

  add)
    need_api
    chain="${2:-}"
    addr="${3:-}"
    label="${4:-}"
    network="${5:-}"
    [ -n "$chain" ] && [ -n "$addr" ] && [ -n "$label" ] || { echo "[augur] usage: augur add CHAIN ADDRESS LABEL [NETWORK]"; exit 1; }
    curl -fsS -X POST "$API_BASE/api/accounts" \
      -H "content-type: application/json" \
      -d "{\"chain\":\"$chain\",\"address_or_identifier\":\"$addr\",\"label\":\"$label\",\"network\":\"$network\"}"
    ;;

  pause)
    need_api
    id="${2:-}"; [ -n "$id" ] || { echo "[augur] usage: augur pause ACCOUNT_ID"; exit 1; }
    curl -fsS -X POST "$API_BASE/api/accounts/$id/pause"
    ;;

  resume)
    need_api
    id="${2:-}"; [ -n "$id" ] || { echo "[augur] usage: augur resume ACCOUNT_ID"; exit 1; }
    curl -fsS -X POST "$API_BASE/api/accounts/$id/resume"
    ;;

  delete)
    need_api
    id="${2:-}"; [ -n "$id" ] || { echo "[augur] usage: augur delete ACCOUNT_ID"; exit 1; }
    curl -fsS -X DELETE "$API_BASE/api/accounts/$id"
    ;;

  purge:deleted)
    need_api
    curl -fsS -X POST "$API_BASE/api/accounts/purge-deleted"
    ;;

  snapshot)
    run_root --silent snapshot
    ;;

  monthly)
    month="${2:-}"; [ -n "$month" ] || { echo "[augur] usage: augur monthly YYYY-MM"; exit 1; }
    run_root --silent monthly "$month"
    ;;

  publish)
    run_root --silent publish
    ;;

  *)
    echo "[augur] unknown command: $cmd"
    usage
    exit 1
    ;;
esac
