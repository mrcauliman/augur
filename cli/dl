#!/usr/bin/env bash
set -euo pipefail

ROOT="/var/www/digital-ledger"
VAULT_DEFAULT="$ROOT/vault/sample_vault"
VAULT_PATH="${DL_VAULT_PATH:-$VAULT_DEFAULT}"
API_BASE="http://127.0.0.1:8787"
LOG_FILE="/tmp/dl_api.log"

run_root() { (cd "$ROOT" && pnpm "$@"); }

need_api() {
  curl -fsS "$API_BASE/health" >/dev/null 2>&1 || {
    echo "[dl] api not reachable on :8787"
    echo "[dl] run: dl api"
    exit 1
  }
}

json_kv() {
  python3 - "$@" <<'PY'
import json, sys
args = sys.argv[1:]
if len(args) % 2 != 0:
  raise SystemExit("[dl] json_kv needs key value pairs")
d = {}
for i in range(0, len(args), 2):
  k = args[i]
  v = args[i+1]
  if v == "__null__":
    continue
  d[k] = v
print(json.dumps(d))
PY
}

usage() {
  cat <<'EOF'
DL CLI

Core
  dl status
  dl api            foreground dev server (watch)
  dl api:bg         background api (non-watch)
  dl api:stop       stop port 8787 listener
  dl api:logs       tail api log
  dl snapshot
  dl monthly YYYY-MM
  dl publish

Accounts
  dl accounts
  dl accounts:all
  dl add CHAIN ADDRESS LABEL [NETWORK]
  dl pause ACCOUNT_ID
  dl resume ACCOUNT_ID
  dl delete ACCOUNT_ID

Vault
  dl vault:path
EOF
}

cmd="${1:-}"
case "$cmd" in
  ""|"-h"|"--help")
    usage
    ;;
  status)
    echo "[dl] root $ROOT"
    echo "[dl] vault $VAULT_PATH"
    echo "[dl] git $(cd "$ROOT" && git rev-parse --short HEAD)"
    ;;
  api)
    run_root dev:api
    ;;
  api:bg)
    if curl -fsS "$API_BASE/health" >/dev/null 2>&1; then
      echo "[dl] api already up"
      exit 0
    fi
    (
      cd "$ROOT/apps/api"
      nohup pnpm start </dev/null >"$LOG_FILE" 2>&1 &
      disown || true
    )
    sleep 1
    if curl -fsS "$API_BASE/health" >/dev/null 2>&1; then
      echo "[dl] api up (bg) log=$LOG_FILE"
    else
      echo "[dl] api failed to start, log follows"
      sed -n '1,200p' "$LOG_FILE" || true
      exit 1
    fi
    ;;
  api:logs)
    [ -f "$LOG_FILE" ] || { echo "[dl] no log at $LOG_FILE"; exit 1; }
    tail -n 120 "$LOG_FILE"
    ;;
  api:stop)
    pid="$(lsof -t -i :8787 2>/dev/null || true)"
    if [ -n "${pid:-}" ]; then
      kill -9 "$pid" || true
      echo "[dl] killed :8787 pid=$pid"
    else
      echo "[dl] nothing on :8787"
    fi
    ;;
  snapshot)
    run_root snapshot
    ;;
  monthly)
    m="${2:-}"
    [ -n "$m" ] || { echo "[dl] missing YYYY-MM"; exit 1; }
    run_root monthly "$m"
    ;;
  publish)
    run_root publish:public
    ;;

  accounts)
    need_api
    curl -sS "$API_BASE/api/accounts" | python3 - <<'PYF'
import json,sys
j=json.load(sys.stdin)
j["accounts"]=[a for a in j.get("accounts",[]) if a.get("status")=="active"]
print(json.dumps(j))
PYF
    ;;
  add)
    need_api
    chain="${2:-}"; addr="${3:-}"; label="${4:-}"; net="${5:-}"
    [ -n "$chain" ] && [ -n "$addr" ] && [ -n "$label" ] || { echo "[dl] usage: dl add CHAIN ADDRESS LABEL [NETWORK]"; exit 1; }

    payload="$(json_kv \
      type onchain_wallet \
      chain "$chain" \
      label "$label" \
      address_or_identifier "$addr" \
      network "${net:-__null__}" \
    )"

    curl -sS -X POST "$API_BASE/api/accounts" \
      -H 'content-type: application/json' \
      -d "$payload"
    ;;
  pause)
    need_api
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl pause ACCOUNT_ID"; exit 1; }
    curl -sS -X POST "$API_BASE/api/accounts/$id/pause"
    ;;
  resume)
    need_api
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl resume ACCOUNT_ID"; exit 1; }
    curl -sS -X POST "$API_BASE/api/accounts/$id/resume"
    ;;
  delete)
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl delete ACCOUNT_ID"; exit 1; }
    need_api
    curl -sS -X POST "$API_BASE/api/accounts/$id/delete"
    ;;

  vault:path)
    echo "$VAULT_PATH"
    ;;
  *)
    echo "[dl] unknown command: $cmd"
    usage
    exit 1
    ;;
esac
