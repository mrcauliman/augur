#!/usr/bin/env bash
set -euo pipefail

ROOT="/var/www/augur"
VAULT_DEFAULT="$ROOT/vault/sample_vault"
VAULT_PATH="${AUGUR_VAULT_PATH:-${DL_VAULT_PATH:-$VAULT_DEFAULT}}"
API_BASE="${AUGUR_API_BASE:-http://127.0.0.1:8787}"
LOG_FILE="${AUGUR_LOG_FILE:-/tmp/augur_api.log}"

run_root() { (cd "$ROOT" && pnpm "$@"); }

port_listening() {
  ss -ltnp 2>/dev/null | grep -q ":8787"
}

need_api() {
  curl -fsS "$API_BASE/health" >/dev/null 2>&1 || {
    echo "[augur] api not reachable on :8787"
    echo "[augur] run: augur api or augur api:bg"
    exit 1
  }
}

usage() {
  cat <<'TXT'
AUGUR CLI

Core
  augur status
  augur api            foreground api server
  augur api:bg         background api server
  augur api:stop       stop :8787
  augur api:logs       tail api log
  augur snapshot
  augur monthly YYYY-MM
  augur publish

Accounts
  augur accounts        active only
  augur accounts:all    all statuses
  augur add CHAIN ADDRESS "LABEL" [NETWORK]
  augur pause ACCOUNT_ID
  augur resume ACCOUNT_ID
  augur delete ACCOUNT_ID
  augur purge:deleted   purge deleted accounts via API
TXT
}

cmd="${1:-}"
case "$cmd" in
  ""|-h|--help|help) usage; exit 0 ;;
esac

case "$cmd" in
  status)
    printf '{"root":"%s","vault":"%s","api":"%s","log":"%s"}\n' "$ROOT" "$VAULT_PATH" "$API_BASE" "$LOG_FILE"
    ;;

  api)
    if port_listening; then
      echo "[augur] already listening on :8787"
      exit 0
    fi
    run_root dev:api
    ;;

  api:bg)
    if port_listening; then
      echo "[augur] already listening on :8787"
      exit 0
    fi
    # Start dev server in background, log to file
    (cd "$ROOT" && nohup pnpm dev:api >"$LOG_FILE" 2>&1 & disown) || true
    sleep 1
    if curl -fsS "$API_BASE/health" >/dev/null 2>&1; then
      echo "[augur] api up (bg) log=$LOG_FILE"
      exit 0
    fi
    echo "[augur] api not healthy yet, see log=$LOG_FILE"
    exit 1
    ;;

  api:stop)
    port="8787"
    pid="$(ss -ltnp 2>/dev/null | awk -v p=":$port" '$4 ~ p {print $0}' | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' | head -n 1)"
    if [ -n "${pid:-}" ]; then
      kill "$pid" 2>/dev/null || true
      sleep 1
      echo "[augur] killed :$port"
      exit 0
    fi
    echo "[augur] nothing on :$port"
    ;;

  api:logs)
    # Never start the server here. Just tail the log.
    if [ -f "$LOG_FILE" ]; then
      tail -n 200 -f "$LOG_FILE"
    else
      echo "[augur] no log yet at $LOG_FILE"
      exit 1
    fi
    ;;

  snapshot)
    need_api
    run_root snapshot
    ;;

  monthly)
    need_api
    month="${2:-}"
    [ -n "$month" ] || { echo "[augur] usage: augur monthly YYYY-MM"; exit 1; }
    run_root monthly "$month"
    ;;

  publish)
    need_api
    run_root publish
    ;;

  accounts)
    need_api
    curl -fsS "$API_BASE/api/accounts" || true
    ;;

  accounts:all)
    need_api
    curl -fsS "$API_BASE/api/accounts/all" || true
    ;;

  add)
    need_api
    chain="${2:-}"
    addr="${3:-}"
    label="${4:-}"
    net="${5:-}"
    [ -n "$chain" ] && [ -n "$addr" ] && [ -n "$label" ] || {
      echo "[augur] usage: augur add CHAIN ADDRESS \"LABEL\" [NETWORK]"
      exit 1
    }
    # Build JSON safely
    python3 - <<PY | curl -fsS -X POST "$API_BASE/api/accounts/add" -H "content-type: application/json" -d @-
import json,sys
chain=sys.argv[1]; addr=sys.argv[2]; label=sys.argv[3]; net=(sys.argv[4] if len(sys.argv)>4 else "")
payload={"chain":chain,"address":addr,"label":label}
if net: payload["network"]=net
print(json.dumps(payload))
PY
"$chain" "$addr" "$label" "$net"
    ;;

  pause|resume|delete)
    need_api
    id="${2:-}"
    [ -n "$id" ] || { echo "[augur] usage: augur $cmd ACCOUNT_ID"; exit 1; }
    curl -fsS -X POST "$API_BASE/api/accounts/$cmd" -H "content-type: application/json" -d "{\"account_id\":\"$id\"}" || true
    ;;

  purge:deleted)
    need_api
    curl -fsS -X POST "$API_BASE/api/accounts/purge/deleted" -H "content-type: application/json" -d '{}' || true
    ;;

  *)
    echo "[augur] unknown command: $cmd"
    usage
    exit 1
    ;;
esac
