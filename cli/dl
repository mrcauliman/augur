#!/usr/bin/env bash
set -euo pipefail

ROOT="/var/www/digital-ledger"
VAULT_DEFAULT="$ROOT/vault/sample_vault"
VAULT_PATH="${DL_VAULT_PATH:-$VAULT_DEFAULT}"
API_BASE="http://127.0.0.1:8787"
LOG_FILE="/tmp/dl_api.log"

run_root() { (cd "$ROOT" && pnpm "$@"); }

need_api() {
  curl -fsS "$API_BASE/health" >/dev/null 2>&1 || {
    echo "[dl] api not reachable on :8787"
    echo "[dl] run: dl api or dl api:bg"
    exit 1
  }
}

usage() {
  cat <<'TXT'
DL CLI

Core
  dl status
  dl api            foreground dev server (watch)
  dl api:bg         background api (non-watch)
  dl api:stop       stop port 8787 listener
  dl api:logs       tail api log
  dl snapshot
  dl monthly YYYY-MM
  dl publish

Accounts
  dl accounts        active only
  dl accounts:all    all statuses
  dl add CHAIN ADDRESS LABEL [NETWORK]
  dl pause ACCOUNT_ID
  dl resume ACCOUNT_ID
  dl delete ACCOUNT_ID
  dl purge:deleted   permanently remove deleted accounts

Vault
  dl vault:path
TXT
}

kill_port() {
  local port="$1"
  local pid
  pid="$(lsof -tiTCP:"$port" -sTCP:LISTEN 2>/dev/null || true)"
  if [ -n "${pid:-}" ]; then
    kill "$pid" || true
    sleep 0.2
    pid="$(lsof -tiTCP:"$port" -sTCP:LISTEN 2>/dev/null || true)"
    if [ -n "${pid:-}" ]; then
      kill -9 "$pid" || true
    fi
    echo "[dl] killed :$port"
  else
    echo "[dl] nothing on :$port"
  fi
}

wait_health() {
  local tries=60
  local i=0
  while [ "$i" -lt "$tries" ]; do
    if curl -fsS "$API_BASE/health" >/dev/null 2>&1; then
      return 0
    fi
    i=$((i + 1))
    sleep 0.15
  done
  return 1
}

cmd="${1:-help}"

case "$cmd" in
  help|--help|-h)
    usage
    ;;

  status)
    need_api
    curl -sS "$API_BASE/health"
    echo
    ;;

  api)
    run_root -C apps/api dev
    ;;

  api:bg)
    : >"$LOG_FILE" || true
    nohup bash -lc "cd '$ROOT' && pnpm -C apps/api start" >"$LOG_FILE" 2>&1 &
    disown || true

    if wait_health; then
      echo "[dl] api up (bg) log=$LOG_FILE"
      curl -sS "$API_BASE/health" || true
      echo
      exit 0
    fi

    echo "[dl] api not healthy yet, see log=$LOG_FILE"
    tail -n 120 "$LOG_FILE" || true
    exit 1
    ;;

  api:stop)
    kill_port 8787
    ;;

  api:logs)
    tail -n 200 -f "$LOG_FILE"
    ;;

  snapshot)
    run_root -C apps/api snapshot
    ;;

  monthly)
    month="${2:-}"
    [ -n "$month" ] || { echo "[dl] usage: dl monthly YYYY-MM"; exit 1; }
    run_root -C apps/api monthly "$month"
    ;;

  publish)
    run_root -C apps/api publish
    ;;

  accounts)
    need_api
    curl -sS "$API_BASE/api/accounts"
    ;;

  accounts:all)
    need_api
    curl -sS "$API_BASE/api/accounts?all=1"
    ;;

  add)
    chain="${2:-}"; addr="${3:-}"; label="${4:-}"; net="${5:-}"
    [ -n "$chain" ] && [ -n "$addr" ] && [ -n "$label" ] || { echo "[dl] usage: dl add CHAIN ADDRESS LABEL [NETWORK]"; exit 1; }
    need_api
    if [ -n "${net:-}" ]; then
      curl -sS -X POST "$API_BASE/api/accounts" \
        -H "content-type: application/json" \
        -d "{\"type\":\"onchain_wallet\",\"chain\":\"$chain\",\"label\":\"$label\",\"address_or_identifier\":\"$addr\",\"network\":\"$net\"}"
    else
      curl -sS -X POST "$API_BASE/api/accounts" \
        -H "content-type: application/json" \
        -d "{\"type\":\"onchain_wallet\",\"chain\":\"$chain\",\"label\":\"$label\",\"address_or_identifier\":\"$addr\"}"
    fi
    ;;

  pause)
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl pause ACCOUNT_ID"; exit 1; }
    need_api
    curl -sS -X POST "$API_BASE/api/accounts/$id/pause"
    ;;

  resume)
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl resume ACCOUNT_ID"; exit 1; }
    need_api
    curl -sS -X POST "$API_BASE/api/accounts/$id/resume"
    ;;

  delete)
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl delete ACCOUNT_ID"; exit 1; }
    need_api
    curl -sS -X POST "$API_BASE/api/accounts/$id/delete"
    ;;

  purge:deleted)
    # Permanent cleanup in the local vault file (Tier 0 convenience)
    python3 - "$VAULT_PATH" <<'PY'
import json, sys, os
vault = sys.argv[1]
p = os.path.join(vault, "accounts.json")
if not os.path.exists(p):
  print("[dl] no accounts.json found")
  raise SystemExit(0)
with open(p, "r", encoding="utf-8") as f:
  data = json.load(f)
if isinstance(data, dict) and "accounts" in data and isinstance(data["accounts"], list):
  accounts = data["accounts"]
elif isinstance(data, list):
  accounts = data
else:
  print("[dl] accounts.json unexpected shape")
  raise SystemExit(1)

before = len(accounts)
kept = [a for a in accounts if a.get("status") != "deleted"]
after = len(kept)

tmp = p + ".tmp"
with open(tmp, "w", encoding="utf-8") as f:
  json.dump(kept if isinstance(data, list) else {"accounts": kept}, f, indent=2)
  f.write("\n")
os.replace(tmp, p)

print(f"[dl] purged deleted: before={before} after={after} removed={before-after}")
PY
    ;;

  vault:path)
    echo "$VAULT_PATH"
    ;;

  *)
    echo "[dl] unknown command: $cmd"
    usage
    exit 1
    ;;
esac
