#!/usr/bin/env bash
set -euo pipefail

ROOT="/var/www/digital-ledger"
VAULT_DEFAULT="$ROOT/vault/sample_vault"
VAULT_PATH="${DL_VAULT_PATH:-$VAULT_DEFAULT}"

run_root() { (cd "$ROOT" && pnpm "$@"); }

usage() {
  cat <<'EOF'
DL CLI

Core
  dl status
  dl api
  dl api:stop
  dl snapshot
  dl monthly YYYY-MM
  dl publish

Accounts
  dl accounts
  dl add CHAIN ADDRESS LABEL [NETWORK]
  dl pause ACCOUNT_ID
  dl resume ACCOUNT_ID

Vault
  dl vault:path
EOF
}

cmd="${1:-}"
case "$cmd" in
  ""|"-h"|"--help")
    usage
    ;;
  status)
    echo "[dl] root $ROOT"
    echo "[dl] vault $VAULT_PATH"
    echo "[dl] git $(cd "$ROOT" && git rev-parse --short HEAD)"
    ;;
  api)
    run_root dev:api
    ;;
  api:stop)
    pid="$(lsof -t -i :8787 2>/dev/null || true)"
    if [ -n "${pid:-}" ]; then
      kill -9 "$pid"
      echo "[dl] killed :8787 pid=$pid"
    else
      echo "[dl] nothing on :8787"
    fi
    ;;
  snapshot)
    run_root snapshot
    ;;
  monthly)
    m="${2:-}"
    [ -n "$m" ] || { echo "[dl] missing YYYY-MM"; exit 1; }
    run_root monthly "$m"
    ;;
  publish)
    run_root publish:public
    ;;
  accounts)
    curl -sS http://127.0.0.1:8787/api/accounts
    ;;
  add)
    chain="${2:-}"; addr="${3:-}"; label="${4:-}"; net="${5:-}"
    [ -n "$chain" ] && [ -n "$addr" ] && [ -n "$label" ] || { echo "[dl] usage: dl add CHAIN ADDRESS LABEL [NETWORK]"; exit 1; }
    if [ -n "$net" ]; then
      curl -sS -X POST http://127.0.0.1:8787/api/accounts         -H 'content-type: application/json'         -d "{"type":"onchain_wallet","chain":"$chain","label":"$label","address_or_identifier":"$addr","network":"$net"}"
    else
      curl -sS -X POST http://127.0.0.1:8787/api/accounts         -H 'content-type: application/json'         -d "{"type":"onchain_wallet","chain":"$chain","label":"$label","address_or_identifier":"$addr"}"
    fi
    ;;
  pause)
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl pause ACCOUNT_ID"; exit 1; }
    curl -sS -X POST "http://127.0.0.1:8787/api/accounts/$id/pause"
    ;;
  resume)
    id="${2:-}"; [ -n "$id" ] || { echo "[dl] usage: dl resume ACCOUNT_ID"; exit 1; }
    curl -sS -X POST "http://127.0.0.1:8787/api/accounts/$id/resume"
    ;;
  vault:path)
    echo "$VAULT_PATH"
    ;;
  *)
    echo "[dl] unknown command: $cmd"
    usage
    exit 1
    ;;
esac
