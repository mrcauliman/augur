#!/usr/bin/env bash
set -euo pipefail

ROOT="/var/www/augur"
VAULT_DEFAULT="$ROOT/vault/sample_vault"
VAULT_PATH="${AUGUR_VAULT_PATH:-$VAULT_DEFAULT}"
API_BASE="http://127.0.0.1:8787"
LOG_FILE="/tmp/augur_api.log"

ACCOUNTS_URL_1="$API_BASE/accounts"
ACCOUNTS_URL_2="$API_BASE/api/accounts"
ADD_URL_1="$API_BASE/accounts/add"
ADD_URL_2="$API_BASE/api/accounts/add"
PAUSE_URL_1="$API_BASE/accounts/pause"
PAUSE_URL_2="$API_BASE/api/accounts/pause"
RESUME_URL_1="$API_BASE/accounts/resume"
RESUME_URL_2="$API_BASE/api/accounts/resume"
DELETE_URL_1="$API_BASE/accounts/delete"
DELETE_URL_2="$API_BASE/api/accounts/delete"

run_root() { (cd "$ROOT" && pnpm "$@"); }

need_api() {
  curl -fsS "$API_BASE/health" >/dev/null 2>&1 || {
    echo "[augur] api not reachable on :8787" >&2
    echo "[augur] run: augur api or augur api:bg" >&2
    exit 1
  }
}

try_get() {
  local u1="${1:-}" u2="${2:-}"
  if [ -n "$u1" ] && curl -fsS "$u1" 2>/dev/null; then return 0; fi
  if [ -n "$u2" ] && curl -fsS "$u2" 2>/dev/null; then return 0; fi
  return 1
}

try_post() {
  local u1="${1:-}" u2="${2:-}" body="${3:-}"
  if [ -n "$u1" ] && curl -fsS -H "Content-Type: application/json" -d "$body" "$u1" 2>/dev/null; then return 0; fi
  if [ -n "$u2" ] && curl -fsS -H "Content-Type: application/json" -d "$body" "$u2" 2>/dev/null; then return 0; fi
  return 1
}

usage() {
  cat <<'TXT'
AUGUR CLI

Core
  augur status
  augur api            foreground api server
  augur api:bg         background api server
  augur api:stop       stop :8787
  augur api:logs       tail api log
  augur snapshot
  augur monthly YYYY-MM

Accounts
  augur accounts        active only
  augur accounts:all    all statuses
  augur add CHAIN ADDRESS "LABEL" [NETWORK]
  augur pause ACCOUNT_ID
  augur resume ACCOUNT_ID
  augur delete ACCOUNT_ID
TXT
}

cmd="${1:-}"
case "$cmd" in
  ""|"-h"|"--help"|"help")
    usage
    exit 0
    ;;

  status)
    echo "{\"root\":\"$ROOT\",\"vault\":\"$VAULT_PATH\",\"api\":\"$API_BASE\",\"log\":\"$LOG_FILE\"}"
    ;;

  api)
    exec bash -lc "cd \"$ROOT\" && pnpm -C apps/api dev"
    ;;

  api:bg)
    if ss -ltnp 2>/dev/null | grep -q ":8787"; then
      echo "[augur] already listening on :8787"
      exit 0
    fi
    nohup bash -lc "cd \"$ROOT\" && pnpm -C apps/api dev" >"$LOG_FILE" 2>&1 &
    sleep 0.4
    if curl -fsS "$API_BASE/health" >/dev/null 2>&1; then
      echo "[augur] api up (bg) log=$LOG_FILE"
      exit 0
    fi
    echo "[augur] api not healthy yet, see log=$LOG_FILE" >&2
    exit 1
    ;;

  api:stop)
    if ss -ltnp 2>/dev/null | grep -q ":8787"; then
      pid="$(ss -ltnp 2>/dev/null | awk '/:8787/ {print $NF}' | head -n1 | sed -n 's/.*pid=\([0-9]\+\).*/\1/p')"
      if [ -n "${pid:-}" ]; then
        kill "$pid" 2>/dev/null || true
        echo "[augur] killed :8787"
        exit 0
      fi
    fi
    echo "[augur] nothing on :8787"
    ;;

  api:logs)
    [ -f "$LOG_FILE" ] || { echo "[augur] no log at $LOG_FILE" >&2; exit 1; }
    tail -n 200 -f "$LOG_FILE"
    ;;

  snapshot)
    exec bash -lc "cd \"$ROOT\" && pnpm -C apps/api snapshot"
    ;;

  monthly)
    month="${2:-}"
    [ -n "$month" ] || { echo "[augur] usage: augur monthly YYYY-MM" >&2; exit 1; }
    exec bash -lc "cd \"$ROOT\" && pnpm -C apps/api monthly \"$month\""
    ;;

  accounts:all)
    need_api
    try_get "$ACCOUNTS_URL_1" "$ACCOUNTS_URL_2" || {
      echo "[augur] failed to fetch accounts" >&2
      exit 1
    }
    ;;

  accounts)
    need_api
    try_get "$ACCOUNTS_URL_1" "$ACCOUNTS_URL_2" | python3 -c 'import json,sys; d=json.load(sys.stdin); accts=d.get("accounts",[]); active=[a for a in accts if a.get("status")=="active"]; print(json.dumps({"ok": True, "accounts": active}))' || {
      echo "[augur] failed to fetch accounts" >&2
      exit 1
    }
    ;;

  add)
    need_api
    chain="${2:-}"
    addr="${3:-}"
    label="${4:-}"
    network="${5:-}"

    [ -n "$chain" ] && [ -n "$addr" ] && [ -n "$label" ] || {
      echo "[augur] usage: augur add CHAIN ADDRESS \"LABEL\" [NETWORK]" >&2
      exit 1
    }

    body="$(python3 -c "import json; chain='$chain'; addr='$addr'; label='$label'; network='$network'; body={'type':'onchain_wallet','chain':chain,'label':label,'address_or_identifier':addr}; 
if network and network != '[NETWORK]': body['network']=network
print(json.dumps(body))")"

    try_post "$ADD_URL_1" "$ADD_URL_2" "$body" || {
      echo "[augur] add failed" >&2
      exit 1
    }
    ;;

  pause)
    need_api
    id="${2:-}"
    [ -n "$id" ] || { echo "[augur] usage: augur pause ACCOUNT_ID" >&2; exit 1; }
    body="{\"account_id\":\"$id\"}"
    try_post "$PAUSE_URL_1" "$PAUSE_URL_2" "$body" || { echo "[augur] pause failed" >&2; exit 1; }
    ;;

  resume)
    need_api
    id="${2:-}"
    [ -n "$id" ] || { echo "[augur] usage: augur resume ACCOUNT_ID" >&2; exit 1; }
    body="{\"account_id\":\"$id\"}"
    try_post "$RESUME_URL_1" "$RESUME_URL_2" "$body" || { echo "[augur] resume failed" >&2; exit 1; }
    ;;

  delete)
    need_api
    id="${2:-}"
    [ -n "$id" ] || { echo "[augur] usage: augur delete ACCOUNT_ID" >&2; exit 1; }
    body="{\"account_id\":\"$id\"}"
    try_post "$DELETE_URL_1" "$DELETE_URL_2" "$body" || { echo "[augur] delete failed" >&2; exit 1; }
    ;;

  *)
    echo "[augur] unknown command: $cmd" >&2
    usage
    exit 1
    ;;
esac
